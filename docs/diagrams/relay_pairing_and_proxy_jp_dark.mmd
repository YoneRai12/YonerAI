%%{init: {"theme":"base","themeVariables":{
  "mainBkg":"transparent",
  "textColor":"#e6edf3",
  "lineColor":"#9ca3af",
  "primaryColor":"#111827",
  "primaryTextColor":"#e6edf3",
  "primaryBorderColor":"#6b7280",
  "actorBkg":"#111827",
  "actorBorder":"#6b7280",
  "actorTextColor":"#e6edf3",
  "signalColor":"#e6edf3",
  "signalTextColor":"#e6edf3",
  "sequenceNumberBgColor":"#e6edf3",
  "sequenceNumberColor":"#111827",
  "labelBoxBkgColor":"#111827",
  "labelBoxBorderColor":"#6b7280",
  "labelTextColor":"#e6edf3",
  "loopBkgColor":"#111827",
  "loopBorderColor":"#6b7280",
  "loopTextColor":"#e6edf3",
  "noteBkgColor":"#0b1220",
  "noteBorderColor":"#6b7280",
  "noteTextColor":"#e6edf3",
  "activationBkgColor":"#1f2937",
  "activationBorderColor":"#6b7280",
  "fontSize":"16px"
}}}%%

sequenceDiagram
    autonumber
    participant C as クライアント（Web/iOS/Android/Win/Mac）
    participant R as Relay（WSルータ）
    participant N as Nodeコネクタ（ユーザーPC常駐）
    participant A as ローカルNode API（127.0.0.1）

    Note over N,R: PC側は外向き接続のみ（ポート開放しない）
    N->>R: WS接続（/ws/node）
    R-->>N: node_session確立

    Note over N: Ownerへワンタイムのペアリングコードを表示
    N-->>N: pairing_code生成（TTL + 1回限り）
    N-->>R: pair_offer通知（code_hash, node_id）

    C->>R: POST /api/pair（pairing_code）
    R-->>C: session_token（owner）

    C->>R: WS接続（/ws/client?token=...）
    R-->>C: client_session確立

    loop 多重化（id -> future）
        C->>R: http_proxy {id, method, path, headers?, body?}
        R->>N: 転送 {id, method, path, headers?, body?}
        N->>A: HTTP（ループバック）
        A-->>N: HTTPレスポンス
        N-->>R: 返信 {id, status, headers?, body?}
        R-->>C: 返信 {id, status, headers?, body?}
    end

    Note over R: Harden: pending上限 / timeout / サイズ制限 / 切断時cleanup

