%%{init: {"theme":"base","themeVariables":{
  "mainBkg":"transparent",
  "textColor":"#0f172a",
  "lineColor":"#334155",
  "primaryColor":"#ffffff",
  "primaryTextColor":"#0f172a",
  "primaryBorderColor":"#334155",
  "actorBkg":"#ffffff",
  "actorBorder":"#334155",
  "actorTextColor":"#0f172a",
  "signalColor":"#0f172a",
  "signalTextColor":"#0f172a",
  "sequenceNumberBgColor":"#0f172a",
  "sequenceNumberColor":"#ffffff",
  "labelBoxBkgColor":"#ffffff",
  "labelBoxBorderColor":"#334155",
  "labelTextColor":"#0f172a",
  "loopBkgColor":"#ffffff",
  "loopBorderColor":"#334155",
  "loopTextColor":"#0f172a",
  "noteBkgColor":"#f8fafc",
  "noteBorderColor":"#334155",
  "noteTextColor":"#0f172a",
  "activationBkgColor":"#e2e8f0",
  "activationBorderColor":"#334155",
  "fontSize":"22px"
}}}%%

sequenceDiagram
    autonumber
    participant C as Client (Web/iOS/Android/Win/Mac)
    participant R as Relay (WS router)
    participant N as Node Connector (on user PC)
    participant A as Local Node API (127.0.0.1)

    Note over N,R: Node makes an outbound WS connection (no port-forwarding on the PC).
    N->>R: WS connect (/ws/node)
    R-->>N: node_session established

    Note over N: Show one-time pairing code to the owner
    N-->>N: generate pairing_code (TTL + one-time)
    N-->>R: announce pair_offer(code_hash, node_id)

    C->>R: POST /api/pair (pairing_code)
    R-->>C: session_token (owner)

    C->>R: WS connect (/ws/client?token=...)
    R-->>C: client_session established

    loop Multiplexed requests (id -> future)
        C->>R: http_proxy {id, method, path, headers?, body?}
        R->>N: forward {id, method, path, headers?, body?}
        N->>A: HTTP request (loopback)
        A-->>N: HTTP response
        N-->>R: reply {id, status, headers?, body?}
        R-->>C: reply {id, status, headers?, body?}
    end

    Note over R: Hardening: max pending, per-id timeout, size limits, cleanup on disconnect.
