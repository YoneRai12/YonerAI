%%{init: {"theme":"base","themeVariables":{
  "mainBkg":"transparent",
  "textColor":"#0f172a",
  "lineColor":"#334155",
  "primaryColor":"#ffffff",
  "primaryTextColor":"#0f172a",
  "primaryBorderColor":"#334155",
  "noteBkgColor":"#f8fafc",
  "noteTextColor":"#0f172a",
  "noteBorderColor":"#334155",
  "fontSize":"22px"
}}}%%

flowchart TD
  A[Tool call dispatched tool_name args tool_call_id] --> B{Access control allowlist by role profile}
  B -->|Denied| X[BLOCKED]
  B -->|Allowed| C[Risk scoring tool tags args]
  C --> D{Policy engine decision}
  D -->|Blocked| X
  D -->|Allowed + no approval| E[Execute tool]
  D -->|Approval required| F[Create approval_request pending TTL]
  F --> G[Notify requester approval pending]
  F --> H[Notify owner out_of_band DM Web API]
  H --> I{Approved within TTL}
  I -->|No| J[Denied Expired Timeout]
  I -->|Yes| K{CRITICAL}
  K -->|Yes| L[Require code]
  L -->|Code valid| E
  K -->|No| E
  E --> M[Audit log + artifacts]
  J --> M
  M --> N[Submit tool result to Core dedupe by tool_call_id]
