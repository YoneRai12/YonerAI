# ORA システム更新履歴 (Changelog)

このファイルは、ORAシステムの進化を日単位で記録し、追加機能や修正内容を正確に把握するためのものです。

## 2026-01-05 (安定化と高性能モデルの復旧)

本日は、Discordのレート制限回避、メモリ最適化ロジックの刷新、および最強モデル「Shared Traffic（共有トラフィック）」シリーズの完全復旧とバグ修正を行いました。

### ✨ 追加機能・改善 (Features & Enhancements)

*   **3段階の「ユーザー最適化」戦略の確立**
    *   **即時（Real-time）**: 5メッセージ蓄積ごとに自動で最適化（API不使用）。
    *   **自動（Background）**: 1時間ごとにオンラインユーザーを検索。ローカルログのみを使用し、API消費ゼロ。
    *   **手動（Manual）**: `/optimize_user` 指令により、Discord APIを用いた深掘りスキャンを実行（安全なインターバル設定付き）。
*   **仕様の永続化（マニフェスト作成）**
    *   `ORA_OPTIMIZATION_MANIFEST.md`: 最適化ロジックの固定。
    *   `ORA_MODEL_MANIFEST.md`: 本日の最強モデルリスト（Shared Traffic）の定義。
*   **「忘れるな」警告ヘッダーの埋め込み**
    *   `src/cogs/memory.py` および `src/cogs/ora.py` の先頭に、将来的なデグレードを防ぐための警告文を追加。

### 🔧 致命的なバグの修正 (Critical Bug Fixes)

*   **Shared Traffic モデルの404エラー修復**
    *   `gpt-5.1-codex` が「Chatモデルではない」として拒否される問題を解決。
    *   `llm_client.py` を改造し、Codex系モデルの場合は自動的に `v1/completions` (Legacy Endpoint) に切り替えて通信するロジックを実装。
*   **モデルパラメータの安全性確保**
    *   `gpt-5`系、`o1`系、`codex`系でエラーの原因となる `temperature` パラメータを自動的に削除するフィルタを実装。
*   **LLMフォールバック時のクラッシュ修正**
    *   OpenAIがエラーの際にローカルLLMに切り替わる過程で発生していた `tuple object has no attribute strip` エラー（アンパック漏れ）を修正。

### ⚙️ 設定変更 (Configuration)

*   **高性能モデルの完全復帰**
    *   `src/config.py` のルーター設定を、貴方様の環境で無料利用可能な `gpt-5.1-codex`, `gpt-5.1`, `gpt-5-mini` 等に再設定。
*   **コンソールノイズの低減**
    *   `discord.http` および `discord.gateway` のログレベルを `WARNING` に設定し、レート制限警告などの不要なスパムを抑制。
*   **【緊急修正】最適化ハングアップ（Processing停止）の解決**
    *   `memory.py` 内に古い関数定義（`_analyze_batch`）が重複して存在していたため、最新の修正（ログ出力など）が適用されていなかったバグを修正。
    *   不要な重複コード（約200行）を削除。これにより、送信ログ `Sending...` が正しく表示されるようになります。

2026 01 05 今日やったこと要約

デバッグ基盤の強化
Debugチャンネル 1455097004433604860 へログをリアルタイム転送する仕組みを実装
logger を QueueHandler 対応にして ログ転送の安定性と詰まりにくさを改善
system.py に LogForwarder タスクを追加して 起動時に自動で回るように整理

Healer 2 0 と自己進化の入口づくり
Healer をボタン式にして Apply Dismiss で提案を適用 破棄できるように実装
ボタン操作を管理者ID 1069941291661672498 のみに制限して 誤操作と乗っ取りを防止
dev_request と request_feature を追加して 既存機能で無理な依頼が来たときに 機能追加の提案フローへ繋ぐ土台を作成
判断プロトコルを導入して できるなら既存ツール実行 できないなら進化リクエストへ という分岐を明文化

通知ノイズ対策 と 日本語化
重要通知のみ流すようにフィルタを強化して INFO スパムを抑制
AutoScan の No history found など不要通知をブロック 対象ログのレベルも見直し
Debug通知のタイトルや主要文言を日本語化して 状況が追いやすい表示に変更

メモリ学習 ダッシュボード関連の不具合対応
学習ログが消えて見えていた原因を特定して Memory 系通知が正しく見えるように許可リストを調整
Worker Bot が存在するだけでメインが処理を遠慮して止まるバグを修正 オフラインならメインが処理するように変更
リアルタイム学習を 5メッセージ到達で即トリガーするように修正
勝手な過去ログ大量取得を止めて Discord API レート制限問題を抑制
手動 optimize_user は必要時のみ API を使って深掘りできるよう復旧
バックグラウンドの徐々に深掘りは 低速 429バックオフ付きで復活

自律進化の安全装置 ガードレール実装
backup_manager を追加して 適用前に全体スナップショットをZIPで保存
health_inspector を追加して 適用後に診断を自動実行
診断NGなら自動ロールバックして 失敗レポートを出す流れを Healer 適用処理に統合

セキュリティ 情報漏えい防止
Confidentiality Protocol を入れて 非管理者には ファイルツリー 設定 コード等の内部情報を出さない方針を組み込み
管理者向け詳細は Debugチャンネルへ必ず残す ログの監査性を強化

運用系のバグ修正
discord 429 Rate limit 系のうるさいログを抑制
LogForwarder の msg 未定義エラーを修正
healer.py の Healer クラス欠損による ImportError を修復

ドキュメント化 変更履歴の固定
現在の最適化ルールを ORA_OPTIMIZATION_MANIFEST md に明文化
今後の改変時に必ず参照させる警告ヘッダを memory.py と ora.py に追加
日付で追える変更履歴として ORA_CHANGELOG md を作成し 2026 01 05 の変更点を記録できる形に整備
