<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>YonerAI Setup</title>
    <style>
      :root {
        --bg: #0b0d12;
        --panel: rgba(17, 21, 38, 0.86);
        --panel2: rgba(15, 18, 32, 0.82);
        --text: #e7ecf5;
        --muted: #a5b0c4;
        --line: #1f2533;
        --accent: #7dd3fc;
        --accent2: #60a5fa;
        --ok: #3ddc97;
        --bad: #ff4d5a;
        --warn: #f7b731;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        --sans: "SF Pro Display", "SF Pro Text", "Segoe UI Variable", "Segoe UI", "Noto Sans JP", system-ui, -apple-system, sans-serif;
      }
      body {
        margin: 0;
        font-family: var(--sans);
        background: radial-gradient(1200px 600px at 20% 10%, rgba(73, 211, 255, 0.18), transparent 50%),
          radial-gradient(900px 500px at 90% 30%, rgba(61, 220, 151, 0.14), transparent 55%),
          var(--bg);
        color: var(--text);
      }
      header {
        padding: 20px 18px 10px;
        border-bottom: 1px solid var(--line);
        background: rgba(11, 13, 18, 0.65);
        backdrop-filter: blur(10px);
        position: sticky;
        top: 0;
        z-index: 10;
      }
      h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.2px;
      }
      header p {
        margin: 8px 0 0;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.4;
      }
      main {
        max-width: 980px;
        margin: 0 auto;
        padding: 18px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
      }
      @media (min-width: 980px) {
        .grid {
          grid-template-columns: 1.1fr 0.9fr;
        }
      }
      .card {
        border: 1px solid var(--line);
        background: linear-gradient(180deg, var(--panel), var(--panel2));
        border-radius: 18px;
        padding: 16px;
        box-shadow: 0 10px 35px rgba(0, 0, 0, 0.35);
      }
      .card h2 {
        margin: 0 0 10px;
        font-size: 14px;
        color: var(--text);
      }
      label {
        display: block;
        font-size: 12px;
        color: var(--muted);
        margin: 10px 0 6px;
      }
      input, textarea, select {
        width: 100%;
        box-sizing: border-box;
        padding: 10px 10px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: rgba(11, 13, 18, 0.7);
        color: var(--text);
        outline: none;
        font-family: var(--mono);
        font-size: 12px;
      }
      input[type="checkbox"] {
        width: auto;
        padding: 0;
      }
      textarea { min-height: 84px; resize: vertical; }
      .row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }
      @media (min-width: 720px) {
        .row {
          grid-template-columns: 1fr 1fr;
        }
      }
      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      button {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px 12px;
        background: rgba(125, 211, 252, 0.12);
        color: var(--text);
        cursor: pointer;
        font-weight: 600;
        font-size: 12px;
      }
      button.secondary {
        background: rgba(255, 255, 255, 0.06);
      }
      button.danger {
        background: rgba(255, 77, 90, 0.12);
      }
      code {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--accent);
      }
      .kvs {
        margin: 0;
        padding: 0;
        list-style: none;
        display: grid;
        gap: 8px;
      }
      .kv {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        border: 1px solid var(--line);
        background: rgba(11, 13, 18, 0.45);
        border-radius: 12px;
        padding: 10px 10px;
      }
      .kv b { font-size: 12px; }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 11px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.06);
        color: var(--muted);
      }
      .pill.ok { color: var(--ok); }
      .pill.bad { color: var(--bad); }
      .pill.warn { color: var(--warn); }
      .msg {
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
        white-space: pre-wrap;
      }
      .small {
        font-size: 12px;
        color: var(--muted);
        line-height: 1.45;
      }
      a { color: var(--accent); text-decoration: none; }
      a:hover { text-decoration: underline; }

      /* Advanced settings renderer */
      details.settings {
        border: 1px solid var(--line);
        border-radius: 14px;
        background: rgba(11, 13, 18, 0.28);
        padding: 10px 10px;
      }
      details.settings summary {
        cursor: pointer;
        font-weight: 700;
        font-size: 13px;
        color: var(--text);
        list-style: none;
      }
      details.settings summary::-webkit-details-marker { display: none; }
      .settingsList {
        margin-top: 10px;
        display: grid;
        gap: 10px;
      }
      .settingRow {
        border: 1px solid var(--line);
        border-radius: 14px;
        background: rgba(11, 13, 18, 0.40);
        padding: 12px;
        display: grid;
        gap: 10px;
        grid-template-columns: 1fr;
      }
      @media (min-width: 920px) {
        .settingRow {
          grid-template-columns: 1.1fr 0.9fr;
          align-items: start;
        }
      }
      .settingKey {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--accent);
      }
      .settingDesc {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
        white-space: pre-wrap;
        line-height: 1.4;
      }
      .settingMeta {
        margin-top: 8px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.06);
        color: var(--muted);
        border-radius: 999px;
        padding: 4px 8px;
        font-size: 11px;
      }
      .badge.good { color: var(--ok); }
      .badge.bad { color: var(--bad); }
      .badge.warn { color: var(--warn); }
      .settingChanged {
        border-color: rgba(125, 211, 252, 0.55);
        box-shadow: 0 0 0 2px rgba(125, 211, 252, 0.12) inset;
      }

      /* Segmented control (Apple-ish) */
      .seg {
        display: inline-flex;
        border: 1px solid var(--line);
        border-radius: 999px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.06);
      }
      .seg button {
        appearance: none;
        border: 0;
        background: transparent !important;
        color: var(--muted);
        padding: 8px 10px;
        font-size: 11px;
        font-weight: 700;
        cursor: pointer;
      }
      .seg button + button { border-left: 1px solid var(--line); }
      .seg button.active {
        background: rgba(125, 211, 252, 0.16) !important;
        color: var(--text);
      }
    </style>
  </head>
  <body>
    <header>
      <h1>YonerAI Setup</h1>
      <p>
        Configure tokens and runtime settings via browser.
        Secrets are stored under <code>secrets/</code> (per profile) and non-secrets under <code>state/settings_override.json</code>.
        API never returns secret values (presence only).
      </p>
    </header>

    <main>
      <div class="grid">
        <section class="card">
          <h2>Auth</h2>
          <div class="small">
            If <code>ORA_WEB_API_TOKEN</code> is configured, API calls require a token.
            You can paste it here; it will be stored in this browser (localStorage).
          </div>
          <label>ORA_WEB_API_TOKEN (Bearer)</label>
          <input id="token" placeholder="paste token (optional on localhost if token not set)" />
          <div class="actions">
            <button id="saveToken" class="secondary">Save Token</button>
            <button id="refresh">Refresh Status</button>
          </div>
          <div id="authMsg" class="msg"></div>
        </section>

        <section class="card">
          <h2>Status</h2>
          <ul class="kvs" id="status"></ul>
          <div class="msg" id="statusMsg"></div>
        </section>
      </div>

      <section class="card">
        <h2>Secrets (Stored Under secrets/)</h2>
        <div class="row">
          <div>
            <label>DISCORD_BOT_TOKEN</label>
            <textarea id="DISCORD_BOT_TOKEN" placeholder="Discord bot token"></textarea>
          </div>
          <div>
            <label>OPENAI_API_KEY</label>
            <textarea id="OPENAI_API_KEY" placeholder="OpenAI API key"></textarea>
          </div>
          <div>
            <label>ANTHROPIC_API_KEY</label>
            <textarea id="ANTHROPIC_API_KEY" placeholder="Anthropic API key"></textarea>
          </div>
          <div>
            <label>GROK_API_KEY</label>
            <textarea id="GROK_API_KEY" placeholder="Grok API key"></textarea>
          </div>
          <div>
            <label>ORA_SPOTIFY_CLIENT_SECRET</label>
            <textarea id="ORA_SPOTIFY_CLIENT_SECRET" placeholder="Spotify Client Secret (optional)"></textarea>
          </div>
          <div>
            <label>SEARCH_API_KEY (optional)</label>
            <textarea id="SEARCH_API_KEY" placeholder="Optional search API key (improves web search provider)"></textarea>
          </div>
          <div>
            <label>ADMIN_DASHBOARD_TOKEN (optional)</label>
            <textarea id="ADMIN_DASHBOARD_TOKEN" placeholder="Optional admin dashboard token"></textarea>
          </div>
          <div>
            <label>ORA_WEB_API_TOKEN (optional)</label>
            <textarea id="ORA_WEB_API_TOKEN" placeholder="API token (enables remote access guard)"></textarea>
          </div>
        </div>
        <div class="actions">
          <button id="saveSecrets">Save Secrets</button>
          <button id="clearSecrets" class="danger">Clear All (Danger)</button>
        </div>
        <div class="msg" id="secretsMsg"></div>
      </section>

      <section class="card">
        <h2>Non-Secret Config (Stored Under state/settings_override.json)</h2>
        <div class="small">
          These values are stored per profile and can be applied in two modes:
          <code>override</code> (UI wins) or <code>fill</code> (only when env is missing).
          Restart may be required for some components.
        </div>

        <label>Override Mode</label>
        <select id="SETTINGS_OVERRIDE_MODE">
          <option value="override">override (UI wins)</option>
          <option value="fill">fill (only when env is missing)</option>
        </select>

        <div class="row">
          <div>
            <label>ADMIN_USER_ID</label>
            <input id="ADMIN_USER_ID" placeholder="Discord owner/admin user id" />
          </div>
          <div>
            <label>SUB_ADMIN_IDS</label>
            <input id="SUB_ADMIN_IDS" placeholder="comma separated discord user ids" />
          </div>
          <div>
            <label>VC_ADMIN_IDS</label>
            <input id="VC_ADMIN_IDS" placeholder="comma separated discord user ids" />
          </div>
          <div>
            <label>DISCORD_APP_ID</label>
            <input id="DISCORD_APP_ID" placeholder="Discord application id (optional)" />
          </div>
          <div>
            <label>ORA_DEV_GUILD_ID</label>
            <input id="ORA_DEV_GUILD_ID" placeholder="Dev guild id (optional)" />
          </div>
          <div>
            <label>PUBLIC_BASE_URL</label>
            <input id="PUBLIC_BASE_URL" placeholder="http://127.0.0.1:3333" />
          </div>
          <div>
            <label>ORA_API_BASE_URL</label>
            <input id="ORA_API_BASE_URL" placeholder="http://127.0.0.1:8001" />
          </div>
          <div>
            <label>ORA_CORE_API_URL</label>
            <input id="ORA_CORE_API_URL" placeholder="http://127.0.0.1:8001" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>ORA_PUBLIC_TOOLS</label>
            <textarea id="ORA_PUBLIC_TOOLS" placeholder="comma separated tool names"></textarea>
          </div>
          <div>
            <label>ORA_SUBADMIN_TOOLS</label>
            <textarea id="ORA_SUBADMIN_TOOLS" placeholder="comma separated tool names"></textarea>
          </div>
          <div>
            <label>ORA_OWNER_ONLY_TOOLS</label>
            <textarea id="ORA_OWNER_ONLY_TOOLS" placeholder="comma separated tool names"></textarea>
          </div>
        </div>

        <div class="row">
          <div>
            <label>ORA_SHARED_GUEST_ALLOWED_TOOLS</label>
            <input id="ORA_SHARED_GUEST_ALLOWED_TOOLS" placeholder="comma separated tool names" />
          </div>
          <div>
            <label>ORA_SHARED_GUEST_APPROVAL_MIN_SCORE</label>
            <input id="ORA_SHARED_GUEST_APPROVAL_MIN_SCORE" placeholder="30" />
          </div>
          <div>
            <label>ORA_SHARED_ALLOW_CRITICAL</label>
            <select id="ORA_SHARED_ALLOW_CRITICAL">
              <option value="">(unset)</option>
              <option value="0">0</option>
              <option value="1">1</option>
            </select>
          </div>
          <div>
            <label>ORA_PRIVATE_OWNER_APPROVALS</label>
            <select id="ORA_PRIVATE_OWNER_APPROVALS">
              <option value="">(unset)</option>
              <option value="high">high</option>
              <option value="critical_only">critical_only</option>
              <option value="off">off</option>
            </select>
          </div>
          <div>
            <label>ORA_SHARED_OWNER_APPROVALS</label>
            <select id="ORA_SHARED_OWNER_APPROVALS">
              <option value="">(unset)</option>
              <option value="high">high</option>
              <option value="critical_only">critical_only</option>
              <option value="off">off</option>
            </select>
          </div>
          <div>
            <label>ORA_OWNER_APPROVAL_SKIP_TOOLS</label>
            <input id="ORA_OWNER_APPROVAL_SKIP_TOOLS" placeholder="comma separated tool names" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>ORA_MCP_ENABLED</label>
            <select id="ORA_MCP_ENABLED">
              <option value="">(unset)</option>
              <option value="0">0</option>
              <option value="1">1</option>
            </select>
          </div>
          <div>
            <label>ORA_MCP_ALLOW_DANGEROUS</label>
            <select id="ORA_MCP_ALLOW_DANGEROUS">
              <option value="">(unset)</option>
              <option value="0">0</option>
              <option value="1">1</option>
            </select>
          </div>
          <div>
            <label>ORA_MCP_SERVERS_JSON</label>
            <textarea id="ORA_MCP_SERVERS_JSON" placeholder='[{"name":"artist","command":"python scripts/mock_mcp_artist.py","allowed_tools":["generate_artwork"]}]'></textarea>
          </div>
          <div>
            <label>ORA_MCP_DENY_TOOL_PATTERNS</label>
            <textarea id="ORA_MCP_DENY_TOOL_PATTERNS" placeholder="e.g. web_navigate, system_control.*"></textarea>
          </div>
        </div>

        <div class="row">
          <div>
            <label>ORA_MUSIC_MENTION_TRIGGERS</label>
            <select id="ORA_MUSIC_MENTION_TRIGGERS">
              <option value="">(unset)</option>
              <option value="0">0</option>
              <option value="1">1</option>
            </select>
          </div>
          <div>
            <label>ORA_MUSIC_MENTION_LEVEL</label>
            <select id="ORA_MUSIC_MENTION_LEVEL">
              <option value="">(unset)</option>
              <option value="owner">owner</option>
              <option value="vc_admin">vc_admin</option>
              <option value="user">user</option>
            </select>
          </div>
          <div>
            <label>ORA_MUSIC_MENTION_YOUTUBE_LEVEL</label>
            <select id="ORA_MUSIC_MENTION_YOUTUBE_LEVEL">
              <option value="">(unset)</option>
              <option value="owner">owner</option>
              <option value="vc_admin">vc_admin</option>
              <option value="user">user</option>
            </select>
          </div>
          <div>
            <label>ORA_MUSIC_NATIVE_PICKER</label>
            <select id="ORA_MUSIC_NATIVE_PICKER">
              <option value="">(unset)</option>
              <option value="0">0</option>
              <option value="1">1</option>
            </select>
          </div>
          <div>
            <label>ORA_MUSIC_PLAYLIST_ACTION_UI</label>
            <select id="ORA_MUSIC_PLAYLIST_ACTION_UI">
              <option value="">(unset)</option>
              <option value="0">0</option>
              <option value="1">1</option>
            </select>
          </div>
          <div>
            <label>ORA_MUSIC_QUEUE_ALL_LIMIT</label>
            <input id="ORA_MUSIC_QUEUE_ALL_LIMIT" placeholder="60" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>ORA_RELAY_URL</label>
            <input id="ORA_RELAY_URL" placeholder="ws://127.0.0.1:9010 (or auto)" />
          </div>
          <div>
            <label>ORA_RELAY_EXPOSE_MODE</label>
            <select id="ORA_RELAY_EXPOSE_MODE">
              <option value="">(unset)</option>
              <option value="none">none</option>
              <option value="cloudflared_quick">cloudflared_quick</option>
              <option value="cloudflared_named">cloudflared_named</option>
            </select>
          </div>
          <div>
            <label>ORA_RELAY_PUBLIC_URL_FILE</label>
            <input id="ORA_RELAY_PUBLIC_URL_FILE" placeholder="./.relay_public_url.txt" />
          </div>
          <div>
            <label>ORA_CLOUDFLARED_BIN</label>
            <input id="ORA_CLOUDFLARED_BIN" placeholder="cloudflared" />
          </div>
        </div>
        <div class="actions">
          <button id="saveEnv">Save Config</button>
          <button id="clearEnv" class="danger">Clear Overrides (Danger)</button>
        </div>
        <div class="msg" id="envMsg"></div>
      </section>

      <section class="card">
        <h2>All Settings (Advanced)</h2>
        <div class="small">
          Render and edit all keys from <code>.env.example</code> (plus a few alias keys).
          Use <code>Override Mode</code> above to choose <code>override</code> vs <code>fill</code>.
        </div>
        <label>Filter (key/category)</label>
        <input id="ALL_FILTER" placeholder="e.g. ORA_MUSIC_, RELAY, APPROVAL, DISCORD" />
        <div class="actions">
          <button id="ALL_RENDER" class="secondary">Render</button>
          <button id="ALL_SAVE">Save Changes</button>
          <button id="ALL_RESET" class="secondary">Reset UI</button>
        </div>
        <div class="msg" id="allMsg"></div>
        <div id="allSettings"></div>
      </section>

      <section class="card">
        <h2>CLI Alternative</h2>
        <div class="small">
          Prefer CLI? You can still edit <code>.env</code> directly.
          For secrets, you can also write to the profile-scoped <code>secrets/</code> directory.
        </div>
      </section>
    </main>

    <script>
      const $ = (id) => document.getElementById(id);

      function bearerHeaders() {
        const t = (localStorage.getItem("ora_web_api_token") || "").trim();
        if (!t) return {};
        return { "Authorization": "Bearer " + t };
      }

      async function apiGet(path) {
        const r = await fetch(path, { headers: { ...bearerHeaders() } });
        const txt = await r.text();
        let data = null;
        try { data = JSON.parse(txt); } catch (e) { /* ignore */ }
        if (!r.ok) {
          const msg = (data && (data.detail || data.message)) ? (data.detail || data.message) : txt;
          throw new Error(r.status + " " + msg);
        }
        return data;
      }

      async function apiPost(path, body) {
        const r = await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json", ...bearerHeaders() },
          body: JSON.stringify(body || {})
        });
        const txt = await r.text();
        let data = null;
        try { data = JSON.parse(txt); } catch (e) { /* ignore */ }
        if (!r.ok) {
          const msg = (data && (data.detail || data.message)) ? (data.detail || data.message) : txt;
          throw new Error(r.status + " " + msg);
        }
        return data;
      }

      function pill(ok) {
        const el = document.createElement("span");
        el.className = "pill " + (ok ? "ok" : "bad");
        el.textContent = ok ? "present" : "missing";
        return el;
      }

      function renderStatus(st) {
        const list = $("status");
        list.innerHTML = "";

        const add = (k, v) => {
          const li = document.createElement("li");
          li.className = "kv";
          const left = document.createElement("div");
          const right = document.createElement("div");
          left.innerHTML = "<b>" + k + "</b>";
          right.appendChild(v);
          li.appendChild(left);
          li.appendChild(right);
          list.appendChild(li);
        };

        add("profile", document.createTextNode(st.profile || ""));
        add("instance_id", document.createTextNode(st.instance_id || ""));
        if (st.override_mode) {
          add("override_mode", document.createTextNode(String(st.override_mode)));
          if ($("SETTINGS_OVERRIDE_MODE")) $("SETTINGS_OVERRIDE_MODE").value = String(st.override_mode).toLowerCase() === "fill" ? "fill" : "override";
        }
        if (st.state_dir) add("state_dir", document.createTextNode(String(st.state_dir)));
        if (st.secrets_dir) add("secrets_dir", document.createTextNode(String(st.secrets_dir)));

        const secrets = st.secrets_present || {};
        const secretKeys = Object.keys(secrets);
        const presentSecrets = secretKeys.filter((k) => !!secrets[k]).sort();
        add("secrets_present", document.createTextNode(presentSecrets.length + "/" + secretKeys.length));
        presentSecrets.slice(0, 12).forEach((k) => add(k, pill(true)));
        if (presentSecrets.length > 12) add("secrets_more", document.createTextNode("â€¦"));

        const env = st.env || {};
        const envSources = st.env_sources || {};
        const envKeys = Object.keys(env);
        const configured = envKeys.filter((k) => !!env[k]).sort();
        add("env_configured", document.createTextNode(configured.length + "/" + envKeys.length));

        // Still fill any known inputs on this page (but don't spam the status panel with all keys).
        Object.keys(env).forEach((k) => {
          const v = env[k];
          if (!$(k)) return;
          const el = $(k);
          if (el.tagName === "SELECT") el.value = v || "";
          else el.value = v || "";
        });

        $("statusMsg").textContent = (st.notes || []).join("\\n");
      }

      async function refresh() {
        $("statusMsg").textContent = "Loading...";
        const st = await apiGet("/api/settings/status");
        renderStatus(st);
        return st;
      }

      // ---------------------------------------------------------------------
      // All Settings (Advanced): render schema + allow editing all keys
      // ---------------------------------------------------------------------

      let _allSchema = null;
      const _allRows = new Map(); // key -> { kind, spec, rowEl, inputEl, clearEl, orig }

      function _normBoolValue(v) {
        const s = String(v || "").trim().toLowerCase();
        if (!s) return "";
        if (["1", "true", "yes", "on"].includes(s)) return "1";
        if (["0", "false", "no", "off"].includes(s)) return "0";
        return s;
      }

      function _setRowChanged(rowEl, changed) {
        if (!rowEl) return;
        rowEl.classList.toggle("settingChanged", !!changed);
      }

      function _rowHay(spec) {
        const parts = [spec.key, spec.category || "", spec.kind || "", spec.description || ""];
        return parts.join(" ").toLowerCase();
      }

      function _makeBadge(text, cls) {
        const el = document.createElement("span");
        el.className = "badge" + (cls ? " " + cls : "");
        el.textContent = text;
        return el;
      }

      function _makeEnvInput(spec, currentValue) {
        const t = String(spec.input || "text");
        if (t === "bool") {
          const wrap = document.createElement("div");
          wrap.className = "seg";

          const hid = document.createElement("input");
          hid.type = "hidden";
          wrap.appendChild(hid);

          const mk = (val, label) => {
            const b = document.createElement("button");
            b.type = "button";
            b.dataset.val = val;
            b.textContent = label;
            b.onclick = () => setVal(val);
            wrap.appendChild(b);
            return b;
          };
          const b0 = mk("", "inherit");
          const b1 = mk("1", "on");
          const b2 = mk("0", "off");
          const btns = [b0, b1, b2];

          const setVal = (val) => {
            hid.value = String(val || "");
            btns.forEach((bb) => bb.classList.toggle("active", bb.dataset.val === hid.value));
            hid.dispatchEvent(new Event("change", { bubbles: true }));
            hid.dispatchEvent(new Event("input", { bubbles: true }));
          };

          setVal(_normBoolValue(currentValue));
          return { wrap, input: hid };
        }
        if (t === "textarea" || t === "json") {
          const ta = document.createElement("textarea");
          ta.value = String(currentValue || "");
          return ta;
        }
        if (t === "number") {
          const inp = document.createElement("input");
          inp.type = "number";
          inp.value = String(currentValue || "");
          return inp;
        }
        const inp = document.createElement("input");
        inp.value = String(currentValue || "");
        return inp;
      }

      function _makeSecretInput(spec) {
        const wrap = document.createElement("div");
        wrap.style.display = "grid";
        wrap.style.gap = "8px";

        const ta = document.createElement("textarea");
        ta.placeholder = "Paste new value (leave empty = no change)";
        wrap.appendChild(ta);

        const clearWrap = document.createElement("label");
        clearWrap.style.display = "inline-flex";
        clearWrap.style.alignItems = "center";
        clearWrap.style.gap = "8px";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        clearWrap.appendChild(cb);

        const txt = document.createElement("span");
        txt.className = "small";
        txt.textContent = "Clear secret file (danger)";
        clearWrap.appendChild(txt);

        wrap.appendChild(clearWrap);
        return { wrap, ta, cb };
      }

      function _renderAll(schema, status) {
        const container = $("allSettings");
        container.innerHTML = "";
        _allRows.clear();

        const settings = (schema && schema.settings) ? schema.settings : [];
        const env = (status && status.env) ? status.env : {};
        const envSources = (status && status.env_sources) ? status.env_sources : {};
        const secretsPresent = (status && status.secrets_present) ? status.secrets_present : {};

        // Group by category
        const byCat = new Map();
        settings.forEach((spec) => {
          const cat = String(spec.category || "Other");
          if (!byCat.has(cat)) byCat.set(cat, []);
          byCat.get(cat).push(spec);
        });

        const cats = Array.from(byCat.keys()).sort();
        cats.forEach((cat) => {
          const specs = byCat.get(cat) || [];
          const det = document.createElement("details");
          det.className = "settings";
          det.open = ["Discord", "Roles", "Permissions", "Approvals", "Music", "Relay/Tunnel", "MCP"].includes(cat);

          const sum = document.createElement("summary");
          sum.textContent = cat + " (" + specs.length + ")";
          det.appendChild(sum);

          const list = document.createElement("div");
          list.className = "settingsList";

          specs.forEach((spec) => {
            const key = String(spec.key || "").trim();
            if (!key) return;

            const row = document.createElement("div");
            row.className = "settingRow";
            row.dataset.key = key;
            row.dataset.hay = _rowHay(spec);

            const left = document.createElement("div");
            const k = document.createElement("div");
            k.className = "settingKey";
            k.textContent = key;
            left.appendChild(k);

            const desc = document.createElement("div");
            desc.className = "settingDesc";
            desc.textContent = String(spec.description || "");
            left.appendChild(desc);

            const meta = document.createElement("div");
            meta.className = "settingMeta";
            meta.appendChild(_makeBadge(String(spec.kind || "env"), spec.kind === "secret" ? "warn" : ""));
            if (spec.default) meta.appendChild(_makeBadge("default=" + String(spec.default), ""));
            if (spec.locked) meta.appendChild(_makeBadge("locked", "bad"));

            const kind = String(spec.kind || "env");
            if (kind === "secret") {
              const present = !!secretsPresent[key];
              meta.appendChild(_makeBadge(present ? "present" : "missing", present ? "good" : "bad"));
            } else {
              const src = envSources[key] ? String(envSources[key]) : ((env[key] ? "env" : "unset"));
              meta.appendChild(_makeBadge("src=" + src, src === "override" ? "warn" : ""));
            }
            left.appendChild(meta);

            const right = document.createElement("div");

            if (kind === "secret") {
              const { wrap, ta, cb } = _makeSecretInput(spec);
              right.appendChild(wrap);

              const onChange = () => {
                const changed = cb.checked || ((ta.value || "").trim().length > 0);
                _setRowChanged(row, changed);
              };
              ta.addEventListener("input", onChange);
              cb.addEventListener("change", onChange);

              _allRows.set(key, { kind, spec, rowEl: row, inputEl: ta, clearEl: cb, orig: "" });
            } else {
              const current = env[key] || "";
              if (spec.locked) {
                const inp = document.createElement("input");
                inp.value = String(current || "");
                inp.disabled = true;
                right.appendChild(inp);
                _allRows.set(key, { kind, spec, rowEl: row, inputEl: inp, clearEl: null, orig: String(current || "") });
              } else {
                const inputInfo = _makeEnvInput(spec, current);
                let inp = inputInfo;
                if (inputInfo && inputInfo.wrap && inputInfo.input) {
                  right.appendChild(inputInfo.wrap);
                  inp = inputInfo.input;
                } else {
                  right.appendChild(inputInfo);
                  inp = inputInfo;
                }

                if (
                  inp &&
                  spec.default &&
                  !String(current || "").trim() &&
                  inp.placeholder !== undefined &&
                  !(inp.tagName === "INPUT" && String(inp.type || "").toLowerCase() === "hidden")
                ) {
                  inp.placeholder = String(spec.default);
                }

                const orig = String(current || "");
                const origNorm = (String(spec.input || "") === "bool") ? _normBoolValue(orig) : orig;

                const onChange = () => {
                  const now = (inp.value || "");
                  const nowNorm = (String(spec.input || "") === "bool") ? _normBoolValue(now) : String(now);
                  _setRowChanged(row, nowNorm !== origNorm);
                };
                inp.addEventListener("input", onChange);
                inp.addEventListener("change", onChange);

                _allRows.set(key, { kind, spec, rowEl: row, inputEl: inp, clearEl: null, orig: orig });
              }
            }

            row.appendChild(left);
            row.appendChild(right);
            list.appendChild(row);
          });

          det.appendChild(list);
          container.appendChild(det);
        });

        _applyAllFilter();
      }

      function _applyAllFilter() {
        const q = ($("ALL_FILTER") ? $("ALL_FILTER").value : "").trim().toLowerCase();
        const rows = Array.from(document.querySelectorAll(".settingRow"));
        rows.forEach((row) => {
          const hay = String(row.dataset.hay || "");
          row.style.display = (!q || hay.includes(q)) ? "" : "none";
        });
      }

      async function _renderAllFromApi() {
        $("allMsg").textContent = "Loading schema...";
        const schema = await apiGet("/api/settings/schema");
        const status = await refresh();
        _allSchema = schema;
        _renderAll(schema, status);
        $("allMsg").textContent = "Rendered. Use filter + Save Changes.";
      }

      async function _saveAllChanges() {
        const envChanges = {};
        const secretChanges = {};
        for (const [key, row] of _allRows.entries()) {
          if (row.kind === "secret") {
            const ta = row.inputEl;
            const cb = row.clearEl;
            const v = (ta && ta.value) ? ta.value.trim() : "";
            if (cb && cb.checked) {
              secretChanges[key] = null;
            } else if (v) {
              secretChanges[key] = v;
            }
            continue;
          }
          const spec = row.spec || {};
          if (spec.locked) continue;
          const inp = row.inputEl;
          const orig = String(row.orig || "");
          const t = String(spec.input || "");
          const nowRaw = (inp && inp.value) ? String(inp.value) : "";
          const now = (t === "bool") ? _normBoolValue(nowRaw) : nowRaw.trim();
          const origNorm = (t === "bool") ? _normBoolValue(orig) : orig.trim();
          if (now === origNorm) continue;
          envChanges[key] = now ? now : null;
        }

        const mode = ($("SETTINGS_OVERRIDE_MODE") && $("SETTINGS_OVERRIDE_MODE").value) ? $("SETTINGS_OVERRIDE_MODE").value.trim() : "override";

        const did = [];
        try {
          if (Object.keys(secretChanges).length) {
            await apiPost("/api/settings/secrets", { secrets: secretChanges });
            did.push("secrets");

            // If ORA_WEB_API_TOKEN was changed, keep this browser in sync so the next refresh doesn't 403.
            if (secretChanges["ORA_WEB_API_TOKEN"] !== undefined) {
              const v = secretChanges["ORA_WEB_API_TOKEN"];
              if (typeof v === "string" && v.trim()) {
                localStorage.setItem("ora_web_api_token", v.trim());
                if ($("token")) $("token").value = v.trim();
              } else if (v === null) {
                localStorage.removeItem("ora_web_api_token");
                if ($("token")) $("token").value = "";
              }
            }
          }
          if (Object.keys(envChanges).length) {
            await apiPost("/api/settings/env", { env: envChanges, mode });
            did.push("env");
          }
          if (!did.length) {
            $("allMsg").textContent = "No changes.";
            return;
          }
          $("allMsg").textContent = "Saved: " + did.join(", ") + ". Restart may be required.";
          // Clear secret textareas/checkboxes for safety
          for (const [key, row] of _allRows.entries()) {
            if (row.kind === "secret") {
              if (row.inputEl) row.inputEl.value = "";
              if (row.clearEl) row.clearEl.checked = false;
              _setRowChanged(row.rowEl, false);
            }
          }
          await _renderAllFromApi();
        } catch (e) {
          $("allMsg").textContent = "Error: " + e.message;
        }
      }

      function _resetAllUi() {
        for (const [key, row] of _allRows.entries()) {
          if (row.kind === "secret") {
            if (row.inputEl) row.inputEl.value = "";
            if (row.clearEl) row.clearEl.checked = false;
            _setRowChanged(row.rowEl, false);
            continue;
          }
          const spec = row.spec || {};
          const t = String(spec.input || "");
          const orig = String(row.orig || "");
          if (row.inputEl) {
            row.inputEl.value = (t === "bool") ? _normBoolValue(orig) : orig;
          }
          _setRowChanged(row.rowEl, false);
        }
        $("allMsg").textContent = "Reset.";
      }

      function init() {
        const saved = (localStorage.getItem("ora_web_api_token") || "").trim();
        $("token").value = saved;

        $("saveToken").onclick = () => {
          const t = $("token").value.trim();
          if (t) localStorage.setItem("ora_web_api_token", t);
          else localStorage.removeItem("ora_web_api_token");
          $("authMsg").textContent = "Saved.";
        };

        $("refresh").onclick = async () => {
          try { await refresh(); $("authMsg").textContent = ""; }
          catch (e) { $("statusMsg").textContent = "Error: " + e.message; }
        };

        $("saveSecrets").onclick = async () => {
          const keys = [
            "DISCORD_BOT_TOKEN",
            "OPENAI_API_KEY","ANTHROPIC_API_KEY","GROK_API_KEY",
            "ORA_SPOTIFY_CLIENT_SECRET",
            "SEARCH_API_KEY",
            "ADMIN_DASHBOARD_TOKEN","ORA_WEB_API_TOKEN"
          ];
          const secrets = {};
          keys.forEach((k) => {
            const v = ($(k).value || "").trim();
            if (!v) return;
            secrets[k] = v;
          });
          try {
            const res = await apiPost("/api/settings/secrets", { secrets });
            $("secretsMsg").textContent = "Updated: " + (res.updated || []).join(", ");

            // If user set ORA_WEB_API_TOKEN, also store it for this browser.
            if (secrets["ORA_WEB_API_TOKEN"]) {
              const v = String(secrets["ORA_WEB_API_TOKEN"]).trim();
              localStorage.setItem("ora_web_api_token", v);
              if ($("token")) $("token").value = v;
            }
            await refresh();
          } catch (e) {
            $("secretsMsg").textContent = "Error: " + e.message;
          }
        };

        $("clearSecrets").onclick = async () => {
          if (!confirm("Clear ALL secrets listed on this page?")) return;
          const keys = [
            "DISCORD_BOT_TOKEN",
            "OPENAI_API_KEY","ANTHROPIC_API_KEY","GROK_API_KEY",
            "ORA_SPOTIFY_CLIENT_SECRET",
            "SEARCH_API_KEY",
            "ADMIN_DASHBOARD_TOKEN","ORA_WEB_API_TOKEN"
          ];
          const secrets = {};
          keys.forEach((k) => secrets[k] = null);
          try {
            const res = await apiPost("/api/settings/secrets", { secrets });
            $("secretsMsg").textContent = "Cleared: " + (res.updated || []).join(", ");
            keys.forEach((k) => $(k).value = "");

            // Clearing ORA_WEB_API_TOKEN means this browser should also forget it.
            localStorage.removeItem("ora_web_api_token");
            if ($("token")) $("token").value = "";

            await refresh();
          } catch (e) {
            $("secretsMsg").textContent = "Error: " + e.message;
          }
        };

        $("saveEnv").onclick = async () => {
          const keys = [
            "ADMIN_USER_ID","SUB_ADMIN_IDS","VC_ADMIN_IDS","DISCORD_APP_ID","ORA_DEV_GUILD_ID",
            "ORA_API_BASE_URL","ORA_CORE_API_URL","PUBLIC_BASE_URL",
            "ORA_PUBLIC_TOOLS","ORA_SUBADMIN_TOOLS","ORA_OWNER_ONLY_TOOLS",
            "ORA_SHARED_GUEST_ALLOWED_TOOLS","ORA_SHARED_GUEST_APPROVAL_MIN_SCORE","ORA_SHARED_ALLOW_CRITICAL",
            "ORA_PRIVATE_OWNER_APPROVALS","ORA_SHARED_OWNER_APPROVALS","ORA_OWNER_APPROVAL_SKIP_TOOLS",
            "ORA_MCP_ENABLED","ORA_MCP_ALLOW_DANGEROUS","ORA_MCP_SERVERS_JSON","ORA_MCP_DENY_TOOL_PATTERNS",
            "ORA_MUSIC_MENTION_TRIGGERS","ORA_MUSIC_MENTION_LEVEL","ORA_MUSIC_MENTION_YOUTUBE_LEVEL","ORA_MUSIC_NATIVE_PICKER","ORA_MUSIC_PLAYLIST_ACTION_UI","ORA_MUSIC_QUEUE_ALL_LIMIT",
            "ORA_RELAY_URL","ORA_RELAY_EXPOSE_MODE","ORA_CLOUDFLARED_BIN","ORA_RELAY_PUBLIC_URL_FILE"
          ];
          const env = {};
          keys.forEach((k) => {
            const el = $(k);
            const v = (el.value || "").trim();
            if (!v) return;
            env[k] = v;
          });
          try {
            const mode = ($("SETTINGS_OVERRIDE_MODE") && $("SETTINGS_OVERRIDE_MODE").value) ? $("SETTINGS_OVERRIDE_MODE").value.trim() : "override";
            const res = await apiPost("/api/settings/env", { env, mode });
            $("envMsg").textContent = "Updated: " + (res.updated || []).join(", ");
            await refresh();
          } catch (e) {
            $("envMsg").textContent = "Error: " + e.message;
          }
        };

        $("clearEnv").onclick = async () => {
          if (!confirm("Clear ALL overrides listed on this page?")) return;
          const keys = [
            "ADMIN_USER_ID","SUB_ADMIN_IDS","VC_ADMIN_IDS","DISCORD_APP_ID","ORA_DEV_GUILD_ID",
            "ORA_API_BASE_URL","ORA_CORE_API_URL","PUBLIC_BASE_URL",
            "ORA_PUBLIC_TOOLS","ORA_SUBADMIN_TOOLS","ORA_OWNER_ONLY_TOOLS",
            "ORA_SHARED_GUEST_ALLOWED_TOOLS","ORA_SHARED_GUEST_APPROVAL_MIN_SCORE","ORA_SHARED_ALLOW_CRITICAL",
            "ORA_PRIVATE_OWNER_APPROVALS","ORA_SHARED_OWNER_APPROVALS","ORA_OWNER_APPROVAL_SKIP_TOOLS",
            "ORA_MCP_ENABLED","ORA_MCP_ALLOW_DANGEROUS","ORA_MCP_SERVERS_JSON","ORA_MCP_DENY_TOOL_PATTERNS",
            "ORA_MUSIC_MENTION_TRIGGERS","ORA_MUSIC_MENTION_LEVEL","ORA_MUSIC_MENTION_YOUTUBE_LEVEL","ORA_MUSIC_NATIVE_PICKER","ORA_MUSIC_PLAYLIST_ACTION_UI","ORA_MUSIC_QUEUE_ALL_LIMIT",
            "ORA_RELAY_URL","ORA_RELAY_EXPOSE_MODE","ORA_CLOUDFLARED_BIN","ORA_RELAY_PUBLIC_URL_FILE"
          ];
          const env = {};
          keys.forEach((k) => env[k] = null);
          try {
            const mode = ($("SETTINGS_OVERRIDE_MODE") && $("SETTINGS_OVERRIDE_MODE").value) ? $("SETTINGS_OVERRIDE_MODE").value.trim() : "override";
            const res = await apiPost("/api/settings/env", { env, mode });
            $("envMsg").textContent = "Cleared: " + (res.updated || []).join(", ");
            keys.forEach((k) => { const el=$(k); if (!el) return; if (el.tagName === "SELECT") el.value=""; else el.value=""; });
            await refresh();
          } catch (e) {
            $("envMsg").textContent = "Error: " + e.message;
          }
        };

        // Advanced settings
        if ($("ALL_RENDER")) {
          $("ALL_RENDER").onclick = async () => {
            try { await _renderAllFromApi(); }
            catch (e) { $("allMsg").textContent = "Error: " + e.message; }
          };
        }
        if ($("ALL_SAVE")) $("ALL_SAVE").onclick = _saveAllChanges;
        if ($("ALL_RESET")) $("ALL_RESET").onclick = _resetAllUi;
        if ($("ALL_FILTER")) $("ALL_FILTER").oninput = _applyAllFilter;

        refresh().catch((e) => {
          $("statusMsg").textContent = "Error: " + e.message + "\\n\\nIf ORA_WEB_API_TOKEN is set, paste it above and refresh.";
        });
      }

      init();
    </script>
  </body>
</html>
